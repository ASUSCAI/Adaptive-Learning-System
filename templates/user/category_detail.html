{% extends "user/base.html" %}

{% block title %}{{ category.name }} - Adaptive Learning System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2>{{ category.name }}</h2>
        <div class="progress mb-3">
            <div class="progress-bar {% if user_category.is_mastered() %}bg-success{% else %}bg-primary{% endif %}"
                 role="progressbar"
                 style="width: {{ (user_category.current_knowledge * 100)|round }}%"
                 aria-valuenow="{{ (user_category.current_knowledge * 100)|round }}"
                 aria-valuemin="0"
                 aria-valuemax="100">
                {{ (user_category.current_knowledge * 100)|round }}%
            </div>
        </div>
        {% if user_category.is_mastered() %}
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i> Congratulations! You have mastered this category!
            </div>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4>Current Question</h4>
            </div>
            <div class="card-body">
                <div id="question-container">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div id="answer-feedback" class="alert d-none"></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h4>Learning Statistics</h4>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Knowledge State
                        <span class="badge bg-primary rounded-pill">
                            {{ "%.2f"|format(user_category.current_knowledge) }}
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Status
                        <span class="badge {% if user_category.is_mastered() %}bg-success{% else %}bg-warning{% endif %} rounded-pill">
                            {{ "Mastered" if user_category.is_mastered() else "In Progress" }}
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h4>Learning History</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Question</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            <tr>
                                <td colspan="3" class="text-center">Loading history...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentQuestion = null;
let selectedOption = null;

// Load initial question and history when page loads
document.addEventListener('DOMContentLoaded', () => {
    loadQuestion();
    loadHistory();
});

function loadQuestion() {
    fetch(`/user/category/{{ category.id }}/next-question`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                document.getElementById('question-container').innerHTML = 
                    `<div class="alert alert-warning">${data.error}</div>`;
                return;
            }
            
            currentQuestion = data;
            const optionsHtml = data.options.map(opt => `
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="options" 
                           id="option${opt.id}" value="${opt.id}">
                    <label class="form-check-label" for="option${opt.id}">
                        ${opt.text}
                    </label>
                </div>
            `).join('');
            
            document.getElementById('question-container').innerHTML = `
                <p class="card-text">${data.text}</p>
                <div class="mb-3">
                    ${optionsHtml}
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="submitAnswer()">Submit Answer</button>
                </div>
            `;
            
            // Add event listeners to radio buttons
            document.querySelectorAll('input[name="options"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    selectedOption = e.target.value;
                });
            });
        })
        .catch(error => {
            console.error('Error loading question:', error);
            document.getElementById('question-container').innerHTML = 
                '<div class="alert alert-danger">Error loading question. Please try again.</div>';
        });
}

function submitAnswer() {
    if (!selectedOption) {
        alert('Please select an answer');
        return;
    }
    
    fetch(`/user/category/{{ category.id }}/submit-answer`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            question_id: currentQuestion.question_id,
            option_id: selectedOption
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const feedback = document.getElementById('answer-feedback');
        feedback.textContent = data.explanation;
        feedback.className = `alert ${data.correct ? 'alert-success' : 'alert-danger'}`;
        feedback.classList.remove('d-none');
        
        // Update the progress bar with the new knowledge state
        const progressBar = document.querySelector('.progress-bar');
        const progressValue = Math.round(data.knowledge_state * 100);
        progressBar.style.width = `${progressValue}%`;
        progressBar.setAttribute('aria-valuenow', progressValue);
        progressBar.textContent = `${progressValue}%`;
        
        if (data.correct) {
            setTimeout(() => {
                loadQuestion();
                loadHistory();
                feedback.classList.add('d-none');
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error submitting answer:', error);
        alert('Error submitting answer. Please try again.');
    });
}

function loadHistory() {
    fetch(`/user/category/{{ category.id }}/history`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const tbody = document.getElementById('history-body');
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">No history available</td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.date}</td>
                    <td>${item.question}</td>
                    <td>
                        <span class="badge ${item.result === 'Correct' ? 'bg-success' : 'bg-danger'}">
                            ${item.result}
                        </span>
                    </td>
                </tr>
            `).join('');
        })
        .catch(error => {
            console.error('Error loading history:', error);
            document.getElementById('history-body').innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-danger">
                        Error loading history. Please try again.
                    </td>
                </tr>
            `;
        });
}
</script>
{% endblock %} 